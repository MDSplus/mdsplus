#@(#)$RCSfile$ $Revision$
# @configure_input@

include Makefile.inc

JAVA_APS = javamds \
	   javascope \
           javatraverser \
	   javadispatcher \
	   javadevices \
	   javaclient \
	   mdsobjects/java 

MOTIF_APS = xmdsshr \
	    actions \
	    dwscope \
	    @IDLMDSWIDGETS@ \
            @MITDEVICES@ \
            traverser

HDF5_APS = hdf5

D3D_PACKAGE = d3dshr

PARTS = \
        mdsshr \
        treeshr \
        tdishr \
        tditest \
	xtreeshr \
        @MDSTCPIP@ \
	rtevents \
        mdslibidl \
        cdu     \
        mdsdcl  \
	gen_device \
	@CAMSHR@ \
        @REMCAM@ \
        @CCL@     \
	servershr \
        tcl \
        @TDIC@ \
        mdslib \
        math \
        wfevent \
        setevent \
        mdsmisc \
	scripts \
	rpm \
	mdsobjects/cpp \
        manpages \
        @D3D_PACKAGE@ \
        @JAVA_APS@ \
	@MOTIF_APS@ \
	@MDSSQL@ \
	@IDLMDSEVENT@ \
	@MDSVME@ \
	@HDF5_APS@ \
	@LV@ \
	@MACOSX@


.PHONY: all $(PARTS)
all: $(PARTS)

DIRECTORIES = @MAKEBINDIR@ @MAKELIBDIR@ @MAKESHLIBDIR@ @MAKEUIDDIR@
$(sort $(DIRECTORIES)):
	mkdir -p $@

$(PARTS): $(DIRECTORIES)
	$(MAKE) -C $@

clean_DIRS = $(addprefix clean_, $(PARTS))

.PHONY: clean
clean: $(clean_DIRS)

.PHONY: $(clean_DIRS)
$(clean_DIRS):
	$(MAKE) -C $(@:clean_%=%) clean

.PHONY: full_clean
full_clean: ./devscripts/rm_if clean
	@ $< bin
	@ $< etc
	@ $< lib
	@ $< java/classes
	@ $< java
	@ $< uid
	@ $< config.cache
	@ $< config.log
	@ $< `find . -name '*.in' | \
	      grep -v configure.in | grep -v makekit.in | \
	      awk '{print substr($$1,0,length($$1)-3)}'`

.PHONY: depend
depend:
	cdir=`pwd`;\
	set -e; for dir in $(PARTS) ; do\
	  cd $${dir}; $${MAKE:=make} depend > /dev/null 2> /dev/null; cd $$cdir;\
	done

CHANGELOG :
	devscripts/MakeChangeLog

MISC_PARTS = tdi idl trees setup.sh setup.csh ChangeLog java LabView include mdsobjects/python desktop pixmaps matlab php epics

install: 
	devscripts/mkdirhier @exec_prefix@/local/tdi
	devscripts/mkdirhier @exec_prefix@/java
	cdir=`pwd`;\
	set -e; for dir in $(PARTS) ; do\
	  cd $${dir}; $${MAKE:=make} install; cd $$cdir;\
	done
	tar cf - --exclude="CVS" $(MISC_PARTS) | (cd @exec_prefix@; tar xf -)
	if [ ! -z "$$MDSPLUS_VERSION" ]; then echo "mdsplus_version='$$MDSPLUS_VERSION'" > @exec_prefix@/mdsobjects/python/mdsplus_version.py; fi
	cp MDSplus-License.txt @exec_prefix@ 
	(cd @exec_prefix@; chmod -R 755 $(MISC_PARTS))

# Interdependent directories:
actions: mdsshr tdishr treeshr xmdsshr
cdu: mdsshr
ccl: cdu mdsshr mdsdcl
tcl: cdu mdsshr treeshr tdishr mdstcpip servershr mdsdcl
camshr: cdu mdsdcl
dwscope: xmdsshr
javadevices: javatraverser
javadispatcher: javascope javatraverser
javatraverser: javascope
mdsdcl: cdu mdsshr
mdslib: mdstcpip
mitdevices: gen_device mdsshr tdishr treeshr xmdsshr
rtevents: mdstcpip mdsshr
servershr: mdsdcl tdishr treeshr mdsshr mdstcpip
tdishr: mdsshr treeshr
tditest: tdishr
traverser: xmdsshr
wfevent: tdishr mdsshr

am--refresh:
